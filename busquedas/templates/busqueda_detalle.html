{% extends "index.html" %}
{% load staticfiles %}
{% block head %}
<title>Buscar | OportunidApp</title>
{% endblock %}
{% block content %}
<div class="container div-detail content-info">
	<div class="row habilidad">
		<div class="row">
			<div class="col-xs-12">
				<h3 class="habilidad-titulo">
					{{habilidad.nhabilidad}}
				</h3>
			</div>
		</div>
		<div class="row">
			<div class="col-xs-6 habilidad-foto">
				<figure class="habilidad-foto-content">
					<img src="{{habilidad.foto.url}}" alt="{{habilidad.nhabilidad}}" class="desc-img img-thumbnail">
				</figure>
			</div>
			<div class="col-xs-6 habilidad-descripcion">
				<div class="row habilidad-info">
					<div class="col-xs-12 ">
						<h4><b>Descripción:</b></h4>
						<p align="justify">{{habilidad.descripcion}}</p>
					</div>

					<ul class="col-xs-12 habilidad-metricas">
						<li class="label-descp-2 label-warning col-xs-6 col-md-6 text-center separador-label" data-toggle="tooltip" data-placement="top" title="Calificación">
							<i class="glyphicon glyphicon-star desc3"></i>
							<strong class="desc3">
								{% if habilidad.val_promedio %}
								{{ habilidad.val_promedio }}
								{% else %}
								<span>ninguno</span>
								{% endif %}
							</strong>
						</li>
						<li class="label-descp-2 label-danger col-xs-6 col-md-6 text-center separador-label " data-toggle="tooltip" data-placement="top" title="Precio">
							<i class="glyphicon glyphicon-usd desc3"></i>
							<strong class="desc3">
								{% if habilidad.precio %}
								{{ habilidad.precio }}
								{% else %}
								<span>por acordar</span>
								{% endif %}
							</strong>
						</li>
					</ul>
				</div>
				<div class="row ofertante">
					<div class="col-xs-12 ofertante-info">
						<h4><b>Información del ofertante:</b></h4>
						<div class="ofertante-nombre">
							<img class="fotoOfertante" src="{{habilidad.usuario.foto.url}}" alt="{{habilidad.usuario.}}" width="40">
							{{habilidad.usuario.usuario.first_name}} {{habilidad.usuario.usuario.last_name}}
						</div>
						<ul class="ofertante-datos">
							<li class="label-descp-2 label-telephone col-xs-6 col-md-6 text-center separador-label" data-toggle="tooltip" data-placement="top" title="Número Telefónico">
								<i class="glyphicon glyphicon-phone-alt desc3"></i>
								<strong class="desc3">
									{{ habilidad.usuario.celular1 }}
								</strong>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- Modal -->
	<div class="modal fade" id="modalPregunta" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="myModalLabel">Ingresa o registrate para poder preguntar</h4>
				</div>
				<form id="formularioLogin">
					<div class="modal-body">
						<input autofocus class="form-control" type="text" id="usuario" name="usuario" required>
						<input class="form-control" type="password" id="password" name="password" required>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
						<input type="submit" value="Ingresar" class="btn btn-primary"></input>
					</div>
				</form>
			</div>
		</div>
	</div>
	<div class="row preguntas">
		<h3 class="preguntas-titulo">Preguntas</h3>
		<div class="row moduloPreguntas">
			<div class="row preguntas-nueva preguntar">
				<form action="" method="" class="formularioPregunta">
					<input type="hidden" value="{{habilidad.pk}}" id="habilidad" name="habilidad">
					<span class="glyphicon glyphicon-question-sign"></span>
					<input type="search" id="pregunta" rows="1" name="pregunta" placeholder="Escribe tu pregunta.">
					<input id="preguntar-btn" type="submit" value="Preguntar" class="btn btn-success">
				</form>
			</div>
			<section class="row preguntas" id="preguntas-content">
				{% if preguntas %}
					{% for pregunta in preguntas %}
						<article class="pregunta">
							<div class="contenedorPregunta">
								<span class="glyphicon glyphicon-question-sign"></span>
								<p class="preguntaEspecifica">
									{{pregunta.pregunta}}
								</p>
							</div>
							<div class="contenedorPespuesta">
								{% if pregunta.respuesta %}
									<span class="respuesta glyphicon glyphicon-check"></span>
									<p class="repuestaEspecifica">
										{{pregunta.respuesta.respuesta}}
									</p>
								{% endif %}
							</div>
						</article>
					{% endfor %}
				{% endif %}
			</section>
		</div>
	</div>
	<div class="row sugerencias">
		<h3 class="sugerencias-titulo">Sugerencias de Búsqueda</h3>
		<div class="row">
			{% if recomendados %}
			{% for  recomendado in recomendados %}
			<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="sugerencia">
					<div class="row sugerencia-foto">
						<figure>
							<img src="{{ recomendado.foto.url}}" class="sgr" alt="{{ recomendado.nhabilidad}}">
						</figure>
					</div>
					<div class="row sugerencia-descripcion">
						<h4 class="sugerencia-titulo">
							<a href="#">
								{{ recomendado.nhabilidad}}
							</a>
						</h4>
					</div>
				</div>
			</div>
			{% endfor %}
			{% else %}
			<p>No hay sugerencias para esta búsqueda</p>
			{% endif %}
		</div>
	</div>
</div>
{% verbatim %}
	<script id="pregunta-template" type="text/x-handlebars-template">
		<article class="pregunta">
			<div class="contenedorPregunta">
				<span class="glyphicon glyphicon-question-sign"></span>
				<p class="preguntaEspecifica">
					{{this.pregunta}}
				</p>
			</div>
		</article>
	</script>
{% endverbatim %}
{% endblock content %}
{% block scripts %}
	<script src="{% static 'jsapp/csrf_load.js' %}"></script>
	<script>
	$(function() {

		// Captura el evento de envio de formulario de preguntas
		$('#preguntar-btn').click(function(event){
			event.preventDefault();
			is_authenticate();
		});

		// Verifica si el usuario esta loggeado
		function is_authenticate()
		{
			$.ajax({
				url:  '{% url 'is_auth_ajax' %}' ,
				type: 'GET',
				dataType: 'json',
				success : function(json)
				{
					// abre modal para inicio de sesion
					if(json.auth == 0){
						abrirModal();
					}
					//envia la pregunta 
					else{
						enviarPregunta();
					}
				}
			});
		}

		// formulario de login ajax
		$('#formularioLogin').on('submit', function(event){
			event.preventDefault();
			$.ajax({
				url: '{% url 'login_ajax' %}',
				type: 'POST',
				dataType: 'json',
				data: {
					username:  $('#usuario').val(),
					password: $('#password').val(),
				},
				success: function(json){
					if(json.estado == 0)
						// hace algo si usuario no esta activo
						alert('Este usuario no esta activo!')
					else if(json.estado == 1)
						// hace algo si usuario no esta registrado
						alert('Este usuario no esta registrado')
					else if(json.estado == 2){
						//envia la pregunta
						$('#modalPregunta').modal('hide')
						enviarPregunta()
					}
				}
			});
		});

		function abrirModal(){
			$('#modalPregunta').modal('show')
		}

		function enviarPregunta(){
			$.ajax({
				url: '{% url 'preguntanueva' %}',
				type: 'POST',
				dataType: 'json',
				data:{
					pregunta: $('#pregunta').val(),
					habilidad: $('#habilidad').val(),
				},
				success: function(json){
					if(json.estado == 1){
						var source   = $("#pregunta-template").html();
						var template = Handlebars.compile(source);
						t = template(json);
						$('#preguntas-content').prepend(t);
						//mostrar mensaje
					}
				}
			})
		}
	})
	</script>
{% endblock scripts %}
